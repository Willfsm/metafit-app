<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaFit Workout</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: sans-serif; }
    </style>
</head>
<body class="bg-[#13272E]">
    <div id="root"></div>

    <script type="text/babel">
        // --- DADOS INICIAIS PARA DEMONSTRAÇÃO ---
        const DUMMY_WORKOUTS = [ { id: 'w1', date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), exercises: [{ id: 'e1', name: 'Supino Reto', sets: [{ weight: 80, reps: 10 }, { weight: 80, reps: 8 }] }, { id: 'e2', name: 'Agachamento Livre', sets: [{ weight: 100, reps: 8 }, { weight: 100, reps: 8 }] }] }, { id: 'w2', date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), exercises: [{ id: 'e3', name: 'Supino Reto', sets: [{ weight: 82.5, reps: 8 }, { weight: 82.5, reps: 7 }] }, { id: 'e4', name: 'Levantamento Terra', sets: [{ weight: 120, reps: 5 }] }] } ];
        const DUMMY_PLANS = [
            { id: 'p1', name: "Membros Superiores", exercises: [ {id: 'pe1', name: 'Flexão de braço', target: '3x10'}, {id: 'pe2', name: 'Barra fixa', target: '3x8'}, {id: 'pe3', name: 'Supino Inclinado', target: '3x12'}, {id: 'pe4', name: 'Remada curvada', target: '3x12'} ] },
            { id: 'p2', name: "Membros Inferiores", exercises: [ {id: 'pe5', name: 'Agachamento Livre', target: '4x10'}, {id: 'pe6', name: 'Leg Press', target: '4x12'} ] }
        ];
        const DUMMY_GOALS = {
            Semana: [ { id: 1, text: 'Treinar 4x na semana', completed: false } ],
            Mês: [ { id: 2, text: 'Levantar 100kg no supino', completed: false } ],
            Trimestre: [ { id: 3, text: 'Correr 5km', completed: true } ],
            Semestre: [],
            Ano: []
        };
        const DUMMY_SCHEDULE = { 0: 'p1', 1: 'p2', 2: 'p1', 3: 'p2', 4: 'p1', 5: 'p2', 6: null };

        // --- COMPONENTES AUXILIARES ---
        const ProgressionChart = ({ data, exerciseName }) => {
            const { useMemo } = React;
            if (!data || data.length < 1) return null;
            const maxValue = Math.max(...data.map(d => d.value), 0);
            return (<div className="bg-gray-800 bg-opacity-50 p-4 rounded-lg mt-4"><h4 className="text-sm font-semibold text-gray-300 mb-4 text-center">Progressão para {exerciseName} (Peso Máx)</h4><div className="flex justify-around items-end h-40 space-x-2">{data.map((item, index) => <div key={index} className="flex flex-col items-center flex-1"><div className="text-xs font-bold text-[#E8C69B]">{item.value === -1 ? 'PC' : `${item.value}kg`}</div><div className="w-full bg-[#83B4AE] rounded-t-md" style={{ height: `${(item.value / (maxValue * 1.1)) * 100}%` }} title={`${item.label}: ${item.value}kg`}></div><div className="text-xs text-gray-400 mt-1">{item.label}</div></div>)}</div></div>);
        };

        const Modal = ({ children, visible, onClose, size = 'lg' }) => {
            if (!visible) return null;
            const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl', '2xl': 'max-w-2xl' };
            return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className={`bg-[#1E3A44] border border-gray-700 rounded-xl shadow-2xl w-full ${sizeClasses[size]} max-h-[90vh] flex flex-col`}><div className="p-4 border-b border-gray-700 flex justify-end"><button onClick={onClose} className="text-gray-400 hover:text-white"><lucide.X size={24} /></button></div><div className="overflow-y-auto">{children}</div></div></div>);
        };
        
        const RestTimer = () => { const { useState, useEffect, useRef } = React; const [timeLeft, setTimeLeft] = useState(0); const [isRunning, setIsRunning] = useState(false); const intervalRef = useRef(null); const audioRef = useRef(null); useEffect(() => { if (typeof window !== 'undefined' && !audioRef.current) { const AudioContext = window.AudioContext || window.webkitAudioContext; if (AudioContext) { audioRef.current = new AudioContext(); } } }, []); const playSound = () => { if (!audioRef.current) return; const oscillator = audioRef.current.createOscillator(); const gainNode = audioRef.current.createGain(); oscillator.connect(gainNode); gainNode.connect(audioRef.current.destination); oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(440, audioRef.current.currentTime); gainNode.gain.setValueAtTime(1, audioRef.current.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.00001, audioRef.current.currentTime + 1); oscillator.start(audioRef.current.currentTime); oscillator.stop(audioRef.current.currentTime + 1); }; const startTimer = () => { if (timeLeft <= 0) return; setIsRunning(true); intervalRef.current = setInterval(() => { setTimeLeft(prev => { if (prev <= 1) { clearInterval(intervalRef.current); setIsRunning(false); playSound(); return 0; } return prev - 1; }); }, 1000); }; const stopTimer = () => { clearInterval(intervalRef.current); setIsRunning(false); }; const resetTimer = () => { stopTimer(); setTimeLeft(0); }; const setPresetTime = (seconds) => { stopTimer(); setTimeLeft(seconds); }; useEffect(() => { return () => clearInterval(intervalRef.current); }, []); const formatTime = (seconds) => { const minutes = Math.floor(seconds / 60); const remainingSeconds = seconds % 60; return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`; }; return (<div className="bg-[#13272E] border border-gray-700 text-white p-4 rounded-lg mt-6"><h3 className="text-lg font-bold mb-3 flex items-center justify-center"><lucide.Timer className="mr-2"/>Cronómetro</h3><div className="text-5xl font-mono text-center my-4">{formatTime(timeLeft)}</div><div className="flex justify-center space-x-2 mb-3">{!isRunning && <button onClick={startTimer} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Iniciar</button>}{isRunning && <button onClick={stopTimer} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">Pausar</button>}<button onClick={resetTimer} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Zerar</button></div><div className="flex justify-center space-x-2"><button onClick={() => setPresetTime(30)} className="bg-gray-600 hover:bg-gray-700 text-sm py-1 px-3 rounded-full">30s</button><button onClick={() => setPresetTime(60)} className="bg-gray-600 hover:bg-gray-700 text-sm py-1 px-3 rounded-full">60s</button><button onClick={() => setPresetTime(90)} className="bg-gray-600 hover:bg-gray-700 text-sm py-1 px-3 rounded-full">90s</button><button onClick={() => setPresetTime(120)} className="bg-gray-600 hover:bg-gray-700 text-sm py-1 px-3 rounded-full">2min</button></div></div>); };

        const Logo = () => (
            <div className="flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-[#1E3A44] to-[#13272E] border-2 border-[#487674]">
                <div className="text-center">
                    <span className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#E8C69B] to-[#CB6330]">MetaFit</span>
                    <p className="text-xs font-semibold text-[#83B4AE]">Workout</p>
                </div>
            </div>
        );
        const Clock = () => {
            const { useState, useEffect } = React;
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timerId = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timerId);
            }, []);
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return <div className="text-center text-base text-[#E8C69B] mt-2">
                <span>{time.toLocaleDateString('pt-BR', dateOptions)}</span> | <span>{time.toLocaleTimeString('pt-BR')}</span>
            </div>;
        };
        const WeeklySchedule = ({ schedule, plans, setSchedule }) => {
            const today = new Date().getDay();
            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            return (<div className="bg-[#1E3A44] border border-gray-700 p-4 rounded-xl shadow-lg h-full"><h3 className="font-bold text-lg mb-4 flex items-center text-gray-100"><lucide.Calendar className="mr-2 text-[#83B4AE]"/>Agenda Semanal</h3><div className="space-y-3">{weekDays.map((day, index) => (<div key={index} className={`flex items-center p-2 rounded-lg ${index === today ? 'bg-[#487674] bg-opacity-40' : ''}`}><div className={`font-bold w-12 ${index === today ? 'text-[#E8C69B]' : 'text-gray-300'}`}>{day}</div><select value={schedule[index] || "none"} onChange={e => setSchedule(prev => ({...prev, [index]: e.target.value === "none" ? null : e.target.value}))} className="flex-grow p-1 bg-[#13272E] border border-gray-600 rounded-md text-sm text-gray-200 focus:ring-2 focus:ring-[#E8C69B]"><option value="none">Descanso</option>{plans.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>))}</div></div>);
        };
        const MotivationalQuote = () => { const { useState, useEffect, useCallback } = React; const [quote, setQuote] = useState(''); const [isLoading, setIsLoading] = useState(true); const fetchQuote = useCallback(async () => { setIsLoading(true); const prompt = `Gere uma frase motivacional curta e impactante para alguém que treina musculação, em português. A frase deve ter no máximo 20 palavras e ser inspiradora. Responda APENAS com a frase.`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] }; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const result = await response.json(); if (result.candidates && result.candidates[0].content.parts[0].text) { setQuote(result.candidates[0].content.parts[0].text.trim()); } else { setQuote("A disciplina é a ponte entre metas e realizações."); } } catch (error) { setQuote("Falhar em se preparar é se preparar para falhar."); } finally { setIsLoading(false); } }, []); useEffect(() => { fetchQuote(); }, [fetchQuote]); return (<div className="text-center mt-4"><p className="text-lg italic text-[#E8C69B] min-h-[3rem] flex items-center justify-center">"{isLoading ? <span className="animate-pulse">A sua dedicação de hoje é o seu resultado de amanhã...</span> : quote}"</p><button onClick={fetchQuote} disabled={isLoading} className="mt-2 p-2 text-gray-400 hover:text-[#E8C69B] disabled:opacity-50"><lucide.RefreshCw size={18} className={isLoading ? 'animate-spin' : ''}/></button></div>); };
        const Goals = ({ goals, setGoals }) => {
            const { useState } = React;
            const categories = ['Semana', 'Mês', 'Trimestre', 'Semestre', 'Ano'];
            const [activeTab, setActiveTab] = useState(categories[0]);
            const [newGoalText, setNewGoalText] = useState('');
            const [editingGoal, setEditingGoal] = useState(null);

            const handleAddGoal = () => {
                if (!newGoalText.trim()) return;
                const newGoal = { id: Date.now(), text: newGoalText, completed: false };
                setGoals(prev => ({...prev, [activeTab]: [...(prev[activeTab] || []), newGoal]}));
                setNewGoalText('');
            };

            const toggleGoal = (id) => {
                if (editingGoal?.id === id) return;
                setGoals(prev => ({ ...prev, [activeTab]: prev[activeTab].map(g => g.id === id ? { ...g, completed: !g.completed } : g)}));
            };

            const deleteGoal = (id) => {
                setGoals(prev => ({ ...prev, [activeTab]: prev[activeTab].filter(g => g.id !== id) }));
            };

            const startEditing = (goal) => setEditingGoal({ ...goal });

            const saveEdit = () => {
                if (!editingGoal?.text.trim()) { setEditingGoal(null); return; }
                setGoals(prev => ({ ...prev, [activeTab]: prev[activeTab].map(g => g.id === editingGoal.id ? { ...g, text: editingGoal.text } : g)}));
                setEditingGoal(null);
            };

            return (
                <div className="bg-[#1E3A44] border border-gray-700 p-4 rounded-xl shadow-lg h-full flex flex-col">
                    <h3 className="font-bold text-lg mb-3 flex items-center text-gray-100"><lucide.Target className="mr-2 text-[#CB6330]"/>Quadro de Metas</h3>
                    <div className="flex border-b border-gray-700 mb-3 overflow-x-auto">
                        {categories.map(cat => (
                            <button key={cat} onClick={() => setActiveTab(cat)} className={`px-3 py-2 text-sm font-medium whitespace-nowrap ${activeTab === cat ? 'border-b-2 border-[#CB6330] text-[#E8C69B]' : 'text-gray-400 hover:text-white'}`}>
                                {cat}
                            </button>
                        ))}
                    </div>
                    <div className="space-y-2 mb-3 flex-grow overflow-y-auto pr-2 min-h-[100px]">
                        {(goals[activeTab] || []).map(goal => (
                            <div key={goal.id} className="flex items-center p-1 rounded group">
                                <input type="checkbox" readOnly checked={goal.completed} onClick={() => toggleGoal(goal.id)} className="h-5 w-5 rounded border-gray-500 bg-[#13272E] text-[#CB6330] focus:ring-[#CB6330] cursor-pointer" />
                                {editingGoal?.id === goal.id ? (
                                    <input type="text" value={editingGoal.text} onChange={e => setEditingGoal({...editingGoal, text: e.target.value})} onBlur={saveEdit} onKeyPress={e => e.key === 'Enter' && saveEdit()} autoFocus className="flex-grow mx-3 p-1 bg-[#487674] border border-gray-500 rounded text-gray-200" />
                                ) : (
                                    <span onClick={() => toggleGoal(goal.id)} className={`flex-grow mx-3 text-gray-300 cursor-pointer ${goal.completed ? 'line-through text-gray-500' : ''}`}>{goal.text}</span>
                                )}
                                <div className="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => startEditing(goal)} className="p-1 text-gray-400 hover:text-yellow-400"><lucide.Edit size={16}/></button>
                                    <button onClick={() => deleteGoal(goal.id)} className="p-1 text-gray-400 hover:text-red-500"><lucide.Trash2 size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="flex space-x-2 mt-4 border-t border-gray-700 pt-3">
                        <input value={newGoalText} onChange={e => setNewGoalText(e.target.value)} type="text" placeholder={`Nova meta para ${activeTab}...`} className="flex-grow p-2 bg-[#13272E] border border-gray-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-[#E8C69B]" onKeyPress={(e) => e.key === 'Enter' && handleAddGoal()}/>
                        <button onClick={handleAddGoal} className="bg-[#CB6330] text-white font-bold p-2 rounded-lg hover:bg-[#D69369]"><lucide.Plus size={20}/></button>
                    </div>
                </div>
            );
        };
        const QuickStats = ({ workouts }) => {
            const { useMemo } = React;
            const totalWorkouts = workouts.length;
            const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const workoutsThisWeek = workouts.filter(w => new Date(w.date) > oneWeekAgo).length;

            const benchPressPr = useMemo(() => {
                let maxWeight = 0;
                workouts.forEach(w => w.exercises.forEach(ex => {
                    if (ex.name.toLowerCase().includes('supino')) {
                        ex.sets.forEach(set => {
                            if(set.weight > maxWeight) maxWeight = set.weight;
                        });
                    }
                }));
                return maxWeight > 0 ? `${maxWeight} kg` : 'N/A';
            }, [workouts]);
            
            return (<div className="bg-[#1E3A44] border border-gray-700 p-4 rounded-xl shadow-lg h-full"><h3 className="font-bold text-lg mb-4 flex items-center text-gray-100"><lucide.TrendingUp className="mr-2 text-[#D69369]"/>Estatísticas Rápidas</h3><div className="space-y-4">{[{icon: <lucide.Dumbbell/>, label: 'Total de Treinos', value: totalWorkouts}, {icon: <lucide.Calendar/>, label: 'Treinos (Últimos 7 dias)', value: workoutsThisWeek}, {icon: <lucide.Sparkles/>, label: 'Recorde no Supino', value: benchPressPr}].map(stat => (<div key={stat.label} className="flex items-center justify-between"><div className="flex items-center text-gray-300"><span className="mr-3 text-[#D69369]">{stat.icon}</span>{stat.label}</div><div className="font-bold text-lg text-[#E8C69B]">{stat.value}</div></div>))}</div></div>);
        };


        // --- COMPONENTE PRINCIPAL ---

        function App() {
            const { useState, useEffect, useCallback, useRef, useMemo } = React;
            const [workouts, setWorkouts] = useState([]); const [plans, setPlans] = useState([]); const [goals, setGoals] = useState({}); const [schedule, setSchedule] = useState({});
            const [addWorkoutModalVisible, setAddWorkoutModalVisible] = useState(false); const [chartModalVisible, setChartModalVisible] = useState(false); const [techniqueModalVisible, setTechniqueModalVisible] = useState(false); const [planManagerVisible, setPlanManagerVisible] = useState(false);
            const [editingWorkoutId, setEditingWorkoutId] = useState(null); 
            const [exerciseName, setExerciseName] = useState(''); 
            const [weight, setWeight] = useState(''); 
            const [reps, setReps] = useState('');
            const [series, setSeries] = useState('1');
            const [isBodyweight, setIsBodyweight] = useState(false);
            
            const [currentWorkoutExercises, setCurrentWorkoutExercises] = useState([]); const [chartData, setChartData] = useState([]); const [selectedExercise, setSelectedExercise] = useState('');
            const [workoutType, setWorkoutType] = useState('Peito'); const [isGenerating, setIsGenerating] = useState(false); const [generatedExercises, setGeneratedExercises] = useState([]); const [isFetchingTechnique, setIsFetchingTechnique] = useState(false); const [techniqueText, setTechniqueText] = useState('');

            useEffect(() => {
                setWorkouts(JSON.parse(localStorage.getItem('workouts')) || DUMMY_WORKOUTS);
                setPlans(JSON.parse(localStorage.getItem('plans')) || DUMMY_PLANS);
                setGoals(JSON.parse(localStorage.getItem('goals')) || DUMMY_GOALS);
                setSchedule(JSON.parse(localStorage.getItem('schedule')) || DUMMY_SCHEDULE);
            }, []);

            const saveData = (key, data) => { localStorage.setItem(key, JSON.stringify(data)); };
            useEffect(() => { saveData('workouts', workouts) }, [workouts]);
            useEffect(() => { saveData('plans', plans) }, [plans]);
            useEffect(() => { saveData('goals', goals) }, [goals]);
            useEffect(() => { saveData('schedule', schedule) }, [schedule]);

            const handleGeminiWorkoutSuggestion = async () => { setIsGenerating(true); setGeneratedExercises([]); const prompt = `Você é um personal trainer especialista. Gere uma lista de 5 exercícios para um treino focado em "${workoutType}". Responda APENAS com um objeto JSON contendo uma chave "exercises" que é um array de strings. Exemplo: {"exercises": ["Supino Reto", "Supino Inclinado com Halteres", "Crucifixo na Máquina", "Flexão de Braço", "Mergulho nas Paralelas"]}`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "exercises": { type: "ARRAY", items: { type: "STRING" } } } } } }; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const result = await response.json(); if (result.candidates && result.candidates[0].content.parts[0].text) { const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text); setGeneratedExercises(parsedJson.exercises || []); } else { console.error("Resposta da API Gemini em formato inesperado:", result); alert("Não foi possível gerar sugestões."); } } catch (error) { console.error("Erro ao chamar a API Gemini:", error); alert("Ocorreu um erro de comunicação com a IA."); } finally { setIsGenerating(false); } };
            const handleFetchTechnique = async (exerciseToFetch) => { setSelectedExercise(exerciseToFetch); setTechniqueModalVisible(true); setIsFetchingTechnique(true); setTechniqueText(''); const prompt = `Você é um personal trainer. Descreva de forma clara e concisa a técnica correta para o exercício: "${exerciseToFetch}". Separe o texto em parágrafos para facilitar a leitura.`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] }; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const result = await response.json(); if (result.candidates && result.candidates[0].content.parts[0].text) { setTechniqueText(result.candidates[0].content.parts[0].text); } else { setTechniqueText("Não foi possível obter a descrição da técnica."); } } catch (error) { console.error("Erro ao buscar técnica:", error); setTechniqueText("Ocorreu um erro de comunicação."); } finally { setIsFetchingTechnique(false); } };
            
            const handleAddExerciseToCurrentWorkout = () => {
                if (!exerciseName.trim()) { alert('Preencha o nome do exercício.'); return; }
                const numSeries = parseInt(series, 10) || 1;
                const newSets = [];
                for (let i = 0; i < numSeries; i++) {
                    newSets.push({ weight: isBodyweight ? -1 : parseFloat(weight) || 0, reps: parseInt(reps, 10) || 0 });
                }
                const existingExerciseIndex = currentWorkoutExercises.findIndex(ex => ex.name.toLowerCase() === exerciseName.trim().toLowerCase());
                if (existingExerciseIndex > -1) {
                    const updatedExercises = [...currentWorkoutExercises];
                    updatedExercises[existingExerciseIndex].sets.push(...newSets);
                    setCurrentWorkoutExercises(updatedExercises);
                } else {
                    const newExercise = { id: Date.now().toString(), name: exerciseName.trim(), target: ' ', sets: newSets };
                    setCurrentWorkoutExercises(prev => [...prev, newExercise]);
                }
                setWeight(''); setReps(''); setSeries('1'); setIsBodyweight(false);
            };

            const handleRemoveExerciseFromCurrentWorkout = (exerciseId) => { setCurrentWorkoutExercises(prev => prev.filter(ex => ex.id !== exerciseId)); };
            const resetAndCloseModal = () => { setAddWorkoutModalVisible(false); setCurrentWorkoutExercises([]); setExerciseName(''); setEditingWorkoutId(null); setGeneratedExercises([]); };
            const handleSaveWorkout = () => { if (currentWorkoutExercises.length === 0) { alert('Adicione pelo menos um exercício.'); return; } if (editingWorkoutId) { const updatedWorkouts = workouts.map(w => w.id === editingWorkoutId ? { ...w, exercises: currentWorkoutExercises } : w); setWorkouts(updatedWorkouts); } else { const newWorkout = { id: Date.now().toString(), date: new Date().toISOString(), exercises: currentWorkoutExercises }; const updatedWorkouts = [newWorkout, ...workouts].sort((a,b) => new Date(b.date) - new Date(a.date)); setWorkouts(updatedWorkouts); } resetAndCloseModal(); };
            const handleStartEdit = (workout) => { setEditingWorkoutId(workout.id); setCurrentWorkoutExercises(JSON.parse(JSON.stringify(workout.exercises))); setAddWorkoutModalVisible(true); };
            const handleLoadPlan = useCallback((planId) => { if (!planId) return; const plan = plans.find(p => p.id === planId); if (plan) { const exercisesFromPlan = plan.exercises.map(ex => ({ id: Date.now().toString() + Math.random(), name: ex.name, target: ex.target, sets: [] })); setCurrentWorkoutExercises(exercisesFromPlan); } }, [plans]);
            const handleStartNewWorkout = useCallback(() => { const today = new Date().getDay(); const planIdForToday = schedule[today]; if (planIdForToday) { handleLoadPlan(planIdForToday); } setAddWorkoutModalVisible(true); }, [schedule, handleLoadPlan]);
            const showProgressionChart = (exerciseNameToChart) => { const dataPoints = [...workouts].reverse().map(workout => { const exercise = workout.exercises.find(ex => ex.name === exerciseNameToChart); if (!exercise) return null; const maxWeight = Math.max(...exercise.sets.map(s => s.weight).filter(w => w > 0), 0); return { value: maxWeight, label: new Date(workout.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) }; }).filter(p => p && p.value > 0); if (dataPoints.length < 2) { alert('Precisa de pelo menos dois registos com peso deste exercício para ver a progressão.'); return; } setChartData(dataPoints); setSelectedExercise(exerciseNameToChart); setChartModalVisible(true); };
            const handleDeleteWorkout = (workoutId) => { if (window.confirm("Tem certeza que deseja apagar este treino?")) { setWorkouts(workouts.filter(w => w.id !== workoutId)); } }
            
            const PlanManager = () => {
                const [editingPlan, setEditingPlan] = useState(null);
                const [planName, setPlanName] = useState('');
                const [planExercises, setPlanExercises] = useState([]);
            
                const startEditing = (plan) => { setEditingPlan(plan); setPlanName(plan.name || ''); setPlanExercises(plan.exercises ? JSON.parse(JSON.stringify(plan.exercises)) : []); };
                const savePlan = () => { if (!planName.trim()) { alert("O nome do plano é obrigatório."); return; } const newPlans = [...plans]; if (editingPlan.id) { const index = newPlans.findIndex(p => p.id === editingPlan.id); newPlans[index] = { ...editingPlan, name: planName, exercises: planExercises }; } else { newPlans.push({ id: 'p' + Date.now(), name: planName, exercises: planExercises }); } setPlans(newPlans); setEditingPlan(null); };
                const handleExerciseChange = (planExIndex, field, value) => { const newPlanExercises = [...planExercises]; newPlanExercises[planExIndex][field] = value; setPlanExercises(newPlanExercises); };
                const addExerciseToPlan = () => setPlanExercises([...planExercises, {id: 'pe' + Date.now(), name: '', target: ''}]);
                const removeExerciseFromPlan = (planExId) => setPlanExercises(planExercises.filter(e => e.id !== planExId));
                const deletePlan = (planId) => { if (window.confirm("Tem certeza?")) { setPlans(plans.filter(p => p.id !== planId)); } }

                if (editingPlan) {
                    return (<div className="p-6"><h3 className="text-xl font-bold mb-4 text-gray-200">{editingPlan.id ? 'A editar plano' : 'Criar Novo Plano'}</h3><input value={planName} onChange={e => setPlanName(e.target.value)} placeholder="Nome do Plano" className="w-full p-3 bg-[#13272E] border border-gray-600 rounded-lg mb-4 text-gray-200 focus:ring-2 focus:ring-[#E8C69B]"/>{planExercises.map((ex, index) => (<div key={ex.id} className="flex items-center space-x-2 mb-2"><input value={ex.name} onChange={e => handleExerciseChange(index, 'name', e.target.value)} placeholder="Nome do exercício" className="flex-grow p-2 bg-[#13272E] border border-gray-600 rounded-lg text-gray-200"/><input value={ex.target} onChange={e => handleExerciseChange(index, 'target', e.target.value)} placeholder="Séries x Reps" className="w-28 p-2 bg-[#13272E] border border-gray-600 rounded-lg text-gray-200"/><button onClick={() => removeExerciseFromPlan(ex.id)} className="p-2 text-red-500 hover:bg-red-500 hover:bg-opacity-20 rounded-full"><lucide.Trash2 size={18}/></button></div>))}<button onClick={addExerciseToPlan} className="text-[#83B4AE] font-semibold mt-2 hover:text-[#E8C69B]">+ Adicionar exercício</button><div className="flex justify-end space-x-2 mt-6"><button onClick={() => setEditingPlan(null)} className="bg-gray-600 py-2 px-4 rounded-lg hover:bg-gray-700">Cancelar</button><button onClick={savePlan} className="bg-[#CB6330] text-white py-2 px-4 rounded-lg hover:bg-[#D69369]">Salvar Plano</button></div></div>);
                }
            
                return (<div className="p-6"><h2 className="text-2xl font-bold mb-4 text-gray-200">Gerir Planos de Treino</h2>{plans.map(plan => (<div key={plan.id} className="mb-2 p-3 bg-[#13272E] border border-gray-700 rounded-lg flex justify-between items-center text-gray-300"><span>{plan.name}</span><div className="space-x-2"><button onClick={() => startEditing(plan)} className="p-2 text-[#83B4AE] hover:bg-[#487674] hover:bg-opacity-20 rounded-full"><lucide.Edit size={18}/></button><button onClick={() => deletePlan(plan.id)} className="p-2 text-red-500 hover:bg-red-500 hover:bg-opacity-20 rounded-full"><lucide.Trash2 size={18}/></button></div></div>))}<button onClick={() => startEditing({})} className="w-full mt-4 bg-[#CB6330] text-white py-3 rounded-lg hover:bg-[#D69369]">+ Criar Novo Plano</button></div>);
            };
            
            const groupAndFormatSets = (sets) => {
              if (!sets || sets.length === 0) return 'Nenhuma série registrada';
              const setCounts = new Map();
              sets.forEach(set => {
                  const key = `${set.reps}|${set.weight}`;
                  setCounts.set(key, (setCounts.get(key) || 0) + 1);
              });
              const formattedStrings = [];
              setCounts.forEach((count, key) => {
                  const [reps, weight] = key.split('|');
                  const weightValue = parseFloat(weight);
                  const weightText = weightValue === -1 ? 'PC' : `${weightValue}kg`;
                  formattedStrings.push(`${count}x${reps} ${weightText}`);
              });
              return formattedStrings.join(' / ');
            };
            
            const renderWorkoutItem = (item) => (<div key={item.id} className="bg-[#1E3A44] border border-gray-700 shadow-lg rounded-xl p-5 mb-4 transition-all hover:border-[#487674]"><div className="flex justify-between items-start"><div><p className="text-base font-bold text-gray-200">{new Date(item.date).toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p></div><div className="flex items-center space-x-2"><button onClick={() => handleStartEdit(item)} className="text-gray-400 hover:text-[#83B4AE]"><lucide.Edit size={18} /></button><button onClick={() => handleDeleteWorkout(item.id)} className="text-gray-400 hover:text-red-500"><lucide.X size={18} /></button></div></div><div className="mt-4 space-y-3">{item.exercises.map(ex => (<div key={ex.id} className="bg-[#13272E] p-3 rounded-lg flex justify-between items-center"><button onClick={() => showProgressionChart(ex.name)} className="w-full text-left"><p className="font-semibold text-gray-300">{ex.name}</p><p className="text-sm text-[#83B4AE]">{groupAndFormatSets(ex.sets)}</p></button><button onClick={() => handleFetchTechnique(ex.name)} className="p-2 text-gray-400 hover:text-[#83B4AE] ml-2" title="Ver técnica"><lucide.Info size={20}/></button></div>))}</div></div>);

            return (
                <div className="bg-[#13272E] min-h-screen font-sans text-gray-200">
                    <div className="container mx-auto p-4 md:p-8 max-w-7xl">
                        <header className="text-center my-8">
                            <div className="flex justify-center items-center gap-4">
                                <Logo />
                                <h1 className="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-[#E8C69B] to-[#CB6330] py-2">Projeto Fitness: Sua melhor versão</h1>
                            </div>
                            <MotivationalQuote />
                            <Clock />
                        </header>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            <button className="w-full bg-gradient-to-r from-[#D69369] to-[#CB6330] text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:opacity-90 transition-all flex items-center justify-center space-x-2" onClick={handleStartNewWorkout}>
                                <lucide.Plus size={20} /><span>Registar Treino do Dia</span>
                            </button>
                             <button onClick={() => setPlanManagerVisible(true)} className="w-full bg-[#1E3A44] border border-gray-700 text-[#E8C69B] font-bold py-4 rounded-xl hover:bg-[#487674] hover:bg-opacity-30">
                                Gerir Planos de Treino
                            </button>
                        </div>

                        <section className="space-y-8">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <Goals goals={goals} setGoals={setGoals} />
                                <QuickStats workouts={workouts} />
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <WeeklySchedule schedule={schedule} plans={plans} setSchedule={setSchedule} />
                                <div>
                                    <h2 className="text-2xl font-bold mb-4 text-gray-200">Histórico de Treinos</h2>
                                    <div className="max-h-[450px] overflow-y-auto pr-2 bg-[#13272E] border border-gray-700 p-4 rounded-xl shadow-lg">
                                      {workouts.length > 0 ? workouts.map(renderWorkoutItem) : (<div className="text-center py-16 px-6"><h3 className="text-xl font-semibold text-gray-300">Nenhum treino registado.</h3><p className="text-gray-400 mt-2">Clique no botão acima para começar!</p></div>)}
                                    </div>
                                </div>
                            </div>
                        </section>

                        <Modal visible={addWorkoutModalVisible} onClose={resetAndCloseModal} size="2xl">
                            <div className="p-6">
                                <h2 className="text-2xl font-bold text-center mb-6">{editingWorkoutId ? 'Editar Treino' : 'Novo Treino'}</h2>
                                <div className="bg-[#487674] bg-opacity-20 border-2 border-[#487674] p-4 rounded-lg mb-6"><h3 className="text-lg font-bold mb-2 flex items-center text-[#E8C69B]"><lucide.BrainCircuit className="mr-2"/> Sugestão com IA ✨</h3><p className="text-sm text-gray-300 mb-3">Sem ideias? Peça uma sugestão de exercícios.</p><div className="flex space-x-2 items-center"><select value={workoutType} onChange={e => setWorkoutType(e.target.value)} className="flex-grow p-2 bg-[#13272E] border border-gray-600 rounded-lg"><option>Peito</option><option>Costas</option><option>Pernas</option><option>Ombros</option><option>Bíceps</option><option>Tríceps</option></select><button onClick={handleGeminiWorkoutSuggestion} disabled={isGenerating} className="bg-[#D69369] text-white font-semibold py-2 px-4 rounded-lg hover:bg-[#CB6330] disabled:bg-gray-500 flex items-center justify-center min-w-[120px]">{isGenerating ? <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> : "Gerar"}</button></div>{generatedExercises.length > 0 && (<div className="mt-4"><h4 className="font-semibold text-sm mb-2 text-gray-300">Sugestões:</h4><div className="flex flex-wrap gap-2">{generatedExercises.map(ex => <button key={ex} onClick={() => setExerciseName(ex)} className="bg-[#13272E] text-[#E8C69B] text-sm font-semibold py-1 px-3 rounded-full border border-gray-600 hover:bg-[#487674]">{ex}</button>)}</div></div>)}</div>
                                
                                <div className="space-y-4">
                                    <h3 className="text-lg font-bold pt-4 border-t border-gray-700">Registrar Exercícios</h3>
                                    <div className="max-h-[150px] overflow-y-auto pr-2 space-y-2">
                                    {currentWorkoutExercises.map((ex) => (
                                        <div key={ex.id} className="bg-[#13272E] p-2 rounded-lg flex items-center justify-between group">
                                            <div className="flex-grow cursor-pointer" onClick={() => setExerciseName(ex.name)}>
                                                <p className="font-semibold text-gray-300">{ex.name} <span className="text-sm text-gray-400 font-normal">({ex.target})</span></p>
                                            </div>
                                            <button onClick={() => handleRemoveExerciseFromCurrentWorkout(ex.id)} className="p-1 text-gray-500 hover:text-red-500 opacity-20 group-hover:opacity-100 transition-opacity">
                                                <lucide.Trash2 size={16}/>
                                            </button>
                                        </div>
                                    ))}
                                    </div>
                                    <div className="flex items-end space-x-2 border-t border-gray-700 pt-4">
                                        <div className="flex-grow">
                                            <label className="text-sm font-medium">Exercício</label>
                                            <input className="w-full p-2 bg-[#13272E] border border-gray-600 rounded-lg mt-1" placeholder="Clique num exercício ou digite um novo" value={exerciseName} onChange={e => setExerciseName(e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="flex space-x-2">
                                        <div className="w-24">
                                            <label className="text-sm font-medium">Séries</label>
                                            <input className="w-full p-2 bg-[#13272E] border border-gray-600 rounded-lg mt-1" type="number" value={series} onChange={e => setSeries(e.target.value)} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-sm font-medium">Reps</label>
                                            <input className="w-full p-2 bg-[#13272E] border border-gray-600 rounded-lg mt-1" type="number" value={reps} onChange={e => setReps(e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="flex space-x-2">
                                        <div className="flex-1">
                                            <label className="text-sm font-medium">Peso (kg)</label>
                                            <div className="flex items-center space-x-2">
                                            <input className="w-full p-2 bg-[#13272E] border border-gray-600 rounded-lg mt-1" type="number" value={isBodyweight ? '' : weight} onChange={e => setWeight(e.target.value)} disabled={isBodyweight} placeholder={isBodyweight ? 'Peso Corporal' : 'Ex: 80'} />
                                                <button onClick={() => setIsBodyweight(!isBodyweight)} className={`mt-1 py-2 px-3 rounded-lg ${isBodyweight ? 'bg-[#CB6330] text-white' : 'bg-gray-600 text-gray-300'}`}>PC</button>
                                            </div>
                                        </div>
                                        <button onClick={handleAddExerciseToCurrentWorkout} className="self-end bg-[#83B4AE] text-black p-2 rounded-lg hover:opacity-80 mb-1">+</button>
                                    </div>
                                </div>
                                <div className="mt-6 pt-6 border-t border-gray-700">
                                    <h3 className="text-lg font-bold mb-4">Resumo do Treino</h3>
                                    <div className="space-y-2 max-h-48 overflow-y-auto pr-2">
                                        {currentWorkoutExercises.length === 0 ? <p className="text-gray-400 text-center">Nenhum exercício.</p> : currentWorkoutExercises.map((ex, index) => (
                                            <div key={index} className="bg-[#13272E] p-3 rounded-lg">
                                                <p className="font-semibold text-gray-300">{ex.name}</p>
                                                <p className="text-sm text-gray-400">{groupAndFormatSets(ex.sets)}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <RestTimer />
                            </div>
                            <div className="p-4 bg-[#13272E] border-t border-gray-700 flex space-x-3">
                                <button onClick={handleSaveWorkout} className="flex-1 bg-gradient-to-r from-[#D69369] to-[#CB6330] text-white font-bold py-3 rounded-lg hover:opacity-90 flex items-center justify-center">
                                    <lucide.Save className="mr-2" size={18}/>Salvar Treino
                                </button>
                            </div>
                        </Modal>
                        <Modal visible={planManagerVisible} onClose={() => setPlanManagerVisible(false)} size="2xl"><PlanManager/></Modal>
                        <Modal visible={chartModalVisible} onClose={() => setChartModalVisible(false)}><div className="p-6"><h2 className="text-2xl font-bold text-center mb-6">Progressão</h2><ProgressionChart data={chartData} exerciseName={selectedExercise} /></div></Modal>
                        <Modal visible={techniqueModalVisible} onClose={() => setTechniqueModalVisible(false)}><div className="p-6"><h2 className="text-2xl font-bold text-center mb-2 flex items-center justify-center"><lucide.Info className="mr-2"/>Técnica</h2><h3 className="text-xl font-semibold text-center text-[#83B4AE] mb-6">{selectedExercise}</h3>{isFetchingTechnique ? <div className="flex justify-center items-center h-24"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#83B4AE]"></div></div> : <div className="text-gray-300 whitespace-pre-wrap leading-relaxed">{techniqueText}</div>}</div></Modal>
                    </div>
                </div>
            );
        }

        window.addEventListener('load', () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        });
    </script>
</body>
</html>
